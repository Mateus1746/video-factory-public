name: Video Factory Matrix

on:
  workflow_dispatch: # BotÃ£o manual
  schedule:
    - cron: '0 12 * * *' # Roda todos os dias Ã s 12:00 UTC (09:00 HorÃ¡rio de BrasÃ­lia)

jobs:
  factory-worker:
    name: ğŸ­ ${{ matrix.project.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false # Se um projeto falhar, nÃ£o cancela os outros
      matrix:
        project:
          - { name: "Commander Sim", path: "mvp/commander_sim", tag: "commander_sim", needs_node: true }
          - { name: "Vibe Geometry", path: "mvp/vibe_geometry", tag: "vibe_geometry", needs_node: false }
          - { name: "Fortress Merge", path: "mvp/fortress_merge", tag: "Fortress_merge", needs_node: false }
          - { name: "Marble War", path: "mvp/marble war", tag: "marble_paint_war", needs_node: false }
          - { name: "Roguelike", path: "mvp/roguelike_survival_", tag: "neon_survivor_lab", needs_node: false }
          - { name: "Arena Algos", path: "mvp/the_arena_of_algoritms", tag: "the_arena_of_algoritms", needs_node: false }
          - { name: "Velocity Odds", path: "mvp/velocity_odds", tag: "velocity_odds", needs_node: false }

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Set up Node.js (Conditional)
      if: ${{ matrix.project.needs_node }}
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python Tools (uv)
      run: |
        pip install --upgrade pip
        pip install uv
        pip install -r requirements.txt
        # Ensure all other potential deps are present for any project
        pip install pillow scipy numpy pygame yt-dlp google-api-python-client google-auth-oauthlib google-auth-httplib2

    - name: Debug Installed Packages
      run: pip list

    - name: Install Node Deps (Conditional)
      if: ${{ matrix.project.needs_node }}
      run: |
        cd "${{ matrix.project.path }}"
        npm install

    - name: ğŸ¬ Generate Videos (Batch 5)
      id: generate
      run: |
        echo "ğŸš€ Starting generation for ${{ matrix.project.name }}..."
        cd "${{ matrix.project.path }}"
        # Run batch pipeline generating 5 videos
        python batch_pipeline.py 5

    - name: ğŸ·ï¸ Tag Videos
      if: steps.generate.outcome == 'success'
      run: |
        # Check if batch_output exists, otherwise use root
        TARGET_DIR="${{ matrix.project.path }}"
        if [ -d "${{ matrix.project.path }}/batch_output" ]; then
          TARGET_DIR="${{ matrix.project.path }}/batch_output"
        fi
        
        echo "ğŸ·ï¸ Tagging videos in $TARGET_DIR..."
        
        # Run loop to catch multiple files
        for i in {1..10}; do
          python scripts/tag_video.py --dir "$TARGET_DIR" --project "${{ matrix.project.tag }}" || break
        done

    - name: ğŸ“¤ Upload to Drive
      env:
        GDRIVE_CREDENTIALS_JSON: ${{ secrets.GDRIVE_CREDENTIALS_JSON }}
        DRIVE_FOLDER_ID: "101AIv9yfWOGfLl29gb74-n49xzcL2iCn"
      run: |
        echo "ğŸ” Searching for generated videos in ${{ matrix.project.path }}..."
        
        # Find all MP4s in the project folder that match the tag pattern (meaning they were successfully tagged)
        find "${{ matrix.project.path }}" -name "${{ matrix.project.tag }}_*.mp4" -type f -mmin -360 > upload_list.txt
        
        if [ ! -s upload_list.txt ]; then
            echo "âš ï¸ No videos found for upload."
            exit 0
        fi

        echo "ğŸš€ Uploading files:"
        cat upload_list.txt

        while IFS= read -r video; do
            echo "ğŸ“¤ Uploading $video..."
            python scripts/upload_to_drive.py "$video" "$DRIVE_FOLDER_ID"
        done < upload_list.txt