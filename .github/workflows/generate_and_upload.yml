name: Video Factory Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'mvp/**'
      - 'scripts/**'

jobs:
  build-and-generate:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # Allow 6 hours for batch processing

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Set up Node.js (for Web-based sims)
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python Tools (uv)
      run: |
        pip install --upgrade pip
        pip install uv
        pip install -r requirements.txt
        # Common libs that might be needed across projects if not in requirements
        pip install moviepy pillow scipy numpy pygame yt-dlp google-api-python-client google-auth-oauthlib google-auth-httplib2

    # --- PROJECT: Commander Sim ---
    - name: Install Node Deps (Commander Sim)
      run: |
        cd mvp/commander_sim
        npm install

    - name: Run Commander Sim
      id: gen_commander
      continue-on-error: true
      run: |
        echo "üé¨ Generating Commander Sim..."
        cd mvp/commander_sim
        python batch_pipeline.py
    
    - name: Tag Commander Sim
      if: steps.gen_commander.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/commander_sim --project "Commander_Sim"

    # --- PROJECT: Vibe Geometry ---
    - name: Run Vibe Geometry
      id: gen_vibe
      continue-on-error: true
      run: |
        echo "üé¨ Generating Vibe Geometry..."
        cd mvp/vibe_geometry
        # batch_pipeline uses 'uv run', so uv must be installed (done above)
        python batch_pipeline.py 1 # Generate 1 video

    - name: Tag Vibe Geometry
      if: steps.gen_vibe.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/vibe_geometry/batch_output --project "Vibe_Geometry"

    # --- PROJECT: Fortress Merge ---
    - name: Run Fortress Merge
      id: gen_fortress
      continue-on-error: true
      run: |
        echo "üé¨ Generating Fortress Merge..."
        cd mvp/fortress_merge
        python batch_pipeline.py
    
    - name: Tag Fortress Merge
      if: steps.gen_fortress.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/fortress_merge --project "Fortress_Merge"

    # --- PROJECT: Marble War ---
    - name: Run Marble War
      id: gen_marble
      continue-on-error: true
      run: |
        echo "üé¨ Generating Marble War..."
        cd "mvp/marble war"
        python batch_pipeline.py

    - name: Tag Marble War
      if: steps.gen_marble.outcome == 'success'
      run: python scripts/tag_video.py --dir "mvp/marble war" --project "Marble_War"

    # --- PROJECT: Roguelike Survival ---
    - name: Run Roguelike Survival
      id: gen_rogue
      continue-on-error: true
      run: |
        echo "üé¨ Generating Roguelike Survival..."
        cd mvp/roguelike_survival_
        python batch_pipeline.py

    - name: Tag Roguelike Survival
      if: steps.gen_rogue.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/roguelike_survival_ --project "Roguelike_Survival"

    # --- PROJECT: Arena of Algorithms ---
    - name: Run Arena of Algorithms
      id: gen_arena
      continue-on-error: true
      run: |
        echo "üé¨ Generating Arena of Algorithms..."
        cd mvp/the_arena_of_algoritms
        python batch_pipeline.py
    
    - name: Tag Arena of Algorithms
      if: steps.gen_arena.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/the_arena_of_algoritms --project "Arena_Of_Algorithms"

    # --- PROJECT: Tower Defense ---
    - name: Run Tower Defense
      id: gen_tower
      continue-on-error: true
      run: |
        echo "üé¨ Generating Tower Defense..."
        cd mvp/tower_defense
        python batch_pipeline.py
    
    - name: Tag Tower Defense
      if: steps.gen_tower.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/tower_defense --project "Tower_Defense"

    # --- PROJECT: Velocity Odds ---
    - name: Run Velocity Odds
      id: gen_velocity
      continue-on-error: true
      run: |
        echo "üé¨ Generating Velocity Odds..."
        cd mvp/velocity_odds
        python batch_pipeline.py
    
    - name: Tag Velocity Odds
      if: steps.gen_velocity.outcome == 'success'
      run: python scripts/tag_video.py --dir mvp/velocity_odds --project "Velocity_Odds"

    # --- UPLOAD STEP ---
    - name: Find and Upload All Videos
      env:
        GDRIVE_CREDENTIALS_JSON: ${{ secrets.GDRIVE_CREDENTIALS_JSON }}
        # Optional: Drive Folder ID can be hardcoded here or passed to script
        DRIVE_FOLDER_ID: "101AIv9yfWOGfLl29gb74-n49xzcL2iCn"
      run: |
        echo "üîç Searching for ALL generated MP4 files..."
        
        # Find all mp4 files generated in the last 360 minutes that start with "["
        # This ensures we only upload the successfully tagged ones
        find . -name "[*]*.mp4" -type f -mmin -360 > new_videos.txt
        
        if [ ! -s new_videos.txt ]; then
            echo "‚ö†Ô∏è No new TAGGED videos found."
            # Fallback: Find any mp4 just in case tag failed but generation worked
            find . -name "*.mp4" -type f -mmin -360 > new_videos.txt
        fi
        
        if [ ! -s new_videos.txt ]; then
             echo "‚ùå Absolutely no videos found."
             exit 0
        fi

        echo "üöÄ Found videos to upload:"
        cat new_videos.txt

        while IFS= read -r video; do
            echo "üì§ Uploading $video..."
            # Pass folder ID as 2nd arg
            python scripts/upload_to_drive.py "$video" "$DRIVE_FOLDER_ID"
        done < new_videos.txt
